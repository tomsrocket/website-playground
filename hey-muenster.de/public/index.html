<!doctype html>
<html lang="en">
  <head>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3" crossorigin="anonymous">

    <!-- Bootstrap Icon library -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.8.1/font/bootstrap-icons.css" integrity="sha384-He3RckdFB2wffiHOcESa3sf4Ida+ni/fw9SSzAcfY2EPnU1zkK/sLUzw2C5Tyuhj" crossorigin="anonymous">

    <link href="data:image/x-icon;base64,AAABAAEAEBAAAAEACABoBQAAFgAAACgAAAAQAAAAIAAAAAEACAAAAAAAAAEAAAAAAAAAAAAAAAEAAAAAAAALzvMAAAMAAH9rJQB/bDEAbXVMAB2yRwDDlIIAPXlZAEprXABObFYAfot7AF2BeQDAVj8A1NTUALx8cQBof3MAYoZ2AMBbRQAxaFQAAhsSAMaelwCEiooAhXhDAIFhGgCCmoQAApTyAG9qPgDdk4gAZ458AJhDIwBuinkAlqutADdtYwBybzsAZHdTAAIDAQCOrgQANK5xAB2zQgBqeFYAdo58AHWbCwD79voA0NXPAH+OcwCfhDoAfpB5AHt2RwAKDQQACPTxAE5zWgBhh3EAfX1BAI2MbQBJdWkAf3xHALKMfgB2m5EAVXNaAH1fHgA2clgAMFU4AC1VQQB9h2gAdoV9AJhNJwAxXDsAhYZlADRWRACmrKgATG5VAAUOCAD8+/gACAsIAIePZQA0XE0AZ4JsADVjUAA6Z0EAX29GAH5eHABuZjQAS6ofADxkSgCAXhwAfWIfAGhtQAA8aE0AhH1LAGWQewBwhHsAgKCPAIKZlQBnkoEAbot+AEZiVgBXtNQAYXxSAIVnJQBFaFYAEyAaAHCSgQBcgXMAVoGFAGZ9ZwADOPAAwVU/ACNMMQBTblYAaH1wAGWFbQBKd18Aa4NnABIKBgB3e1gAU3ZTAD9jPwB4YiAAj38lADFpWgCtbl0AGcNrADdnVAB+XyAAgYBVAFGYRACGZhoAcIt2AEtdUQA8dFcAPE43ACszLwAaHBgAb5KLAD0tFAB6dT4ANFpJADerLQBre2IAS2xjACZHNQAEvfIAO2JGAH1dGwA7Z0MAsrKqAHtiIQCAmYUAAB8iAGSPegAkWT4Ac4F0AHWFbgAjLioAL1RBAFSBbABJaUkARG9SAHaHfQCEhl8Ag6OjAElsWwBtelcATW5YAI6tnQB9XRwAfV4fAK6ThQBqhnIAb2k3AINiGQA5YmIAaYp+AHJtOgBWemoAPG5ZAEJnVgABBAAAERwaAEJxUAC3UzwAiXhsAIyakgBLZ1YAcpN+AHl0PQCPNhQAYX9wAEJUOQBFdmgAPlpCAISQdQBzf1UAfl8aAF2JhQB3npYAf2EgAFh3YgBRhV8Ad4ZqACpaQwBmj44ARWtRAH+KZABUigwAnUosAAgFBABAdWYATXFRAA8xJACTuw0AfXtBAFuLegCsr60ASHVmAD9aQwA2Y0wAf5SCAH9kIQBniIMAbm4/AFmBVACGgVMA3t4jAG+OegBkcl0AdIh6AH+eoABZgWYARGpYADpMPgBtkYwAJzkzAICPdACBkHcAVGxVAElyZwAgIB8AO2BEAClNMABtZjEAfF8cAKYnFgBei4QAZ4eBAAXk0gCDgVQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAFCq0agwR8kKAgpUcXqRBSFun4J211OR/mwk8ErgezR2TGG6D7zjGD8qsOb3sqLp4edUrRVdMkDpmej5dlnAumFKE1osfcVko4sXPa8fqLOnLM0bl7ba3XBUyyKJKJz+/wF/u12MQS9uMjm/RQzUGcp/ZfSkOPYj0ZfNasjYIBE98CorrJHSFlGegIrvOARtW3iNzaPUZACXC56OXoQuZ3BbTN0eJE2mBviBt0K68Gq12uYdOQJFTmk2rZOPh2FEvLTRYB7Oc0q93ROhhsMnw9nV7VVXahjFgI+YNnsOSIak7JjumxN0FjY+lpUmxVFRU8czx8fFsMN8DYgJQwRd+qgAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA=" rel="icon" type="image/x-icon" />

    <title>Toms Regenradar</title>
    <style>
        .slidecontainer {
  width: 100%; /* Width of the outside container */
}

/* The slider itself */
.slider {
  -webkit-appearance: none;  /* Override default CSS styles */
  appearance: none;
  width: 100%; /* Full-width */
  height: 25px; /* Specified height */
  background: #d3d3d3; /* Grey background */
  outline: none; /* Remove outline */
  opacity: 0.7; /* Set transparency (for mouse-over effects on hover) */
  -webkit-transition: .2s; /* 0.2 seconds transition on hover */
  transition: opacity .2s;
}

/* Mouse-over effects */
.slider:hover {
  opacity: 1; /* Fully shown on mouse-over */
}
#cb {width:100%}
.rainradar {
    max-width: 700px !important;
  background-color: white;
  border-radius: 5px;
  overflow:hidden;
  margin-top: -10px;
  box-shadow: rgba(0, 0, 0, 0.25) 0px 54px 55px, rgba(0, 0, 0, 0.12) 0px -12px 30px, rgba(0, 0, 0, 0.12) 0px 4px 6px, rgba(0, 0, 0, 0.17) 0px 12px 13px, rgba(0, 0, 0, 0.09) 0px -3px 5px;
}
.btn {margin: 2px }
.citybutton {margin-bottom: 5pt; }
#demo {
    background-color: #ccc;
    font-weight: 300;
}
    body {

  --s: 60px; /* control the size*/
  --c1: #b09f79;
  --c2: #476074;

  --_g: #0000 83%,var(--c1) 85% 99%,#0000 101%;
  background:
    radial-gradient(27% 29% at right ,var(--_g)) calc(var(--s)/ 2) var(--s),
    radial-gradient(27% 29% at left  ,var(--_g)) calc(var(--s)/-2) var(--s),
    radial-gradient(29% 27% at top   ,var(--_g)) 0 calc(var(--s)/ 2),
    radial-gradient(29% 27% at bottom,var(--_g)) 0 calc(var(--s)/-2)
    var(--c2);
  background-size: calc(2*var(--s)) calc(2*var(--s));

}
</style>
  </head>
  <body>
        <header class="bg-dark text-white d-flex flex-wrap justify-content-center py-3 mb-4">
          <a href="/" class="d-flex align-items-center mb-3 mb-md-0 me-md-auto text-decoration-none">
            <svg class="bi me-2" width="40" height="32"><use xlink:href="#bootstrap"/></svg>
            <span class="fs-4 text-white">Regenradar RÃ¼ckblick</span>
          </a>

          <ul class="nav nav-pills">
            <li class="nav-item nav-link text-white">Size: <span id="size"></span></li>
            <li class="nav-item"><a href="https://www.input23.de/impressum.html" class="nav-link text-white">Impressum</a></li>
            <li class="nav-item"><a href="https://www.input23.de/datenschutz.html" class="nav-link text-white">Datenschutz</a></li>
          </ul>
        </header>


    <div class="container g-0 rainradar">
      <div class="row">
        <div class="col">
            <div id="demo" class="text-bg-secondary text-center fs-4"></div>

            <img id="cb" src="" />
        </div>
      </div>
      <div class="row">
        <div class="col">
            <div class="slidecontainer">
                <input type="range" min="1" max="100" value="50" class="slider" id="myRange">
            </div>
        </div>
      </div>
      <div class="container g-3">
        <div class="row">
            <div class="col">
                <p class="float-start">00:00</p>
                <p class="float-end">24:00</p>
                <p class="text-center">12:00</p>
        </div></div>
        <div class="row">
            <div class="col">
                <a href="#" class="btn btn-outline-primary citybutton" onclick="setCity(this, 'nrw');return false;">Regen NRW</a>
                <a href="#" class="btn btn-outline-primary active citybutton" onclick="setCity(this, 'de');return false;">Regen DE</a>
                <a href="#" class="btn btn-outline-primary citybutton" onclick="setCity(this, 'wolken');return false;">Wolken DE</a>
            </div>
        </div>
        <div class="row pb-3">
            <div class="col" id="datebuttons">
            </div>
        </div>
      </div>
    </div>

    <!-- Bootstrap Bundle with Popper
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-ka7Sk0Gln4gmtz2MlQnikT1wXgYsOg+OMhuP+IlRH9sENBO0LRn5q+8nbTov4+1p" crossorigin="anonymous"></script> -->
<script>


    // ja ja, global variables
    var kweek = 0
    var filenr = 0
    var imgpath = ""
    var city = "de"
    var today = 0
    var mode = "regen"
    const slider = document.getElementById("myRange");
    const output = document.getElementById("demo");

    // show the total directory size used by regenradar images
    fetch('regen/dirsize.txt')
        .then(response => response.text())
        .then((data) => {
            console.log(data)
            document.getElementById("size").innerHTML=data
        })


    // create the date buttons that call function init_vars($date)
    const datebuttons = document.getElementById("datebuttons")
    var now = new Date()
    for (var ind = 0;ind<10; ind++) {
        const nowIso = now.toISOString()
        const html = '<a href="#" class="btn btn-outline-secondary daybutton" onclick="init_vars(\''
            + nowIso +'\', this);return false;">'+nowIso.substring(0,10)+'</a>'
        datebuttons.innerHTML += html;
        now.setDate(now.getDate() - 1);
    }

    // init all global variables for the current date
    function init_vars(dateIso, ele) {
        const elementlist = document.querySelectorAll('.daybutton');
        for (var i = 0; i < elementlist.length; ++i) {
            elementlist[i].classList.remove('active');
        }
        if (!ele) {ele = document.querySelector('.daybutton');}
        ele.classList.add('active');

        const date = new Date(dateIso)
        const formattedDate = dateIso.replace(/[:T-]/g, '');
        today = formattedDate.substring(0, 8)
        const shortDate = formattedDate.substring(0, 12)
        const rounded5 = round5(shortDate)

        kweek = getWeek(date)
        imgpath = "regen/img/"+('00'+kweek).slice(-2)+"/"
        filenr = rounded5

        console.log("INIT ", kweek, date, formattedDate, shortDate, rounded5 )
    }

    init_vars(new Date().toISOString())


    // helper functions
    function setCity(ele, cc) {
        if (cc == "wolken") {
            city = "de"
            mode = "wolken"
        } else {
            city = cc
            mode = "regen"
        }
        const elementlist = document.querySelectorAll('.citybutton');
        for (var i = 0; i < elementlist.length; ++i) {
            elementlist[i].classList.remove('active');
        }
        ele.classList.add('active');

    }
    function round5(x) {
        // regen bilder gibts nur alle 5 minuten
        return Math.floor(x / 5) * 5;
    }
    function get_filename(filee) {
        var mytime = filee
        if (mode == "wolken") {
            // wolken gibts nur alle 15 minuten
            const minute15 = Math.floor(mytime.toString().substring(10) / 15) * 15
            mytime = "" + mytime.toString().substring(0, 10) + ((minute15 == 0) ? '00':minute15)
        }
        return imgpath + mode + "-"+city+"-" + mytime + ".jpg"
    }

    function preload_image(im_url) {
        let img = new Image();
        img.src = im_url;
    }

    function fixtime(mytime) {
        if ((mytime % 100) >= 60) {
            mytime = "" + mytime.toString().substring(0, 10) + "55"
        }
        if ((mytime % 10000) > 2355) {
            mytime = "" + mytime.toString().substring(0, 8) + "2355"
        }
        return mytime
    }

    // change the image every xxx milliseconds
    function cycle( dummy = "") {
        showImage();
        // calculate nr of next image
        filenr = filenr -5;
        filenr = fixtime(filenr)
        if (filenr % 100 == 0) {
            console.log("TIMEVAL", filenr.toString(), filenr.toString().substring(8))
            document.getElementById("myRange").value = filenr.toString().substring(8) / 24
        }
        preload_image(get_filename(filenr))
    }
    function showImage() {
        document.querySelector('#cb').src = get_filename(filenr);
        const ff = filenr.toString()
        output.innerHTML = `${ff.substr(6,2)}.${ff.substr(4,2)}.${ff.substr(0,4)} ${ff.substr(8,2)}:${ff.substr(10,2)} Uhr`;
    }

    // Start/Stop Regenradar Image Animation when mouse pressed
    function startAnimation() {
        inter = setInterval(cycle, 200);
    }
    function stopAnimation() {
        clearInterval(inter);
    }
    startAnimation()

    window.onmousedown = () => {
        console.log("holding..")
        stopAnimation()
    }
    window.onmouseup = () => {
        console.log("released...")
        startAnimation()
    }

    // Update the current slider value (each time you drag the slider handle)
    slider.oninput = function() {
        var zero = ""
        var temptime = Math.floor( (this.value * 24) / 5) * 5
        if (temptime < 1000) {
            zero = "0"
        }
        var mytime = "" + today + "" +  zero + temptime
        mytime = fixtime(mytime)

        filenr = mytime
        showImage()
    }

    function getWeek(d){
        // Quelle: https://itbalance.de/javascript-und-die-kalenderwoche/
        if (!d) {
            return 0;
        }

        let date;
        if (d instanceof Date) {
            date = new Date(d.getTime());
        } else {
            // deliver JSON Date
            const x = d.split('-');
            date = new Date(x[0], x[1] - 1, x[2], 11); // 11 = independent of time zone date switch
        }
        // january, 4th is always in week 1.
        const week1 = new Date(date.getFullYear(), 0, 4, 11, 0, 0, 0);
        const week1Monday = new Date(week1.getTime());
        // get the monday of the first week
        week1Monday.setDate(week1Monday.getDate() - (week1Monday.getDay() || 7) + 1);

        // check, if cal week is equal to last week of past year
        if (week1Monday.getTime() > date.getTime()) {
            if (week1Monday.getFullYear() === week1.getFullYear()) {
                return getWeek(new Date(week1Monday.getFullYear() - 1, 11, 31, 11));
            }
            return getWeek(new Date(week1Monday.getFullYear(), 11, 31, 11));
        }

        const firstOfYear  = new Date(date.getFullYear(), 0, 1, 11, 0, 0, 0);
        const lastOfYear  = new Date(date.getFullYear(), 11, 31, 11, 0, 0, 0);

        // check if current year is a leap year
        const isLeap = date.getFullYear() % 4 === 0;

        // check if current year has 53 weeks
        const has53 = !isLeap && (firstOfYear.getDay() === 4 && lastOfYear.getDay() === 4)  ||
            (isLeap && (firstOfYear.getDay() === 3 && lastOfYear.getDay() === 4 || firstOfYear.getDay() === 4 && lastOfYear.getDay() === 5));

        const dateMonday = new Date(date.getTime());
        dateMonday.setDate(dateMonday.getDate() - (dateMonday.getDay() || 7) + 1);

        // round is needed due to summer time / winter time difference ends up in non integer calculation
        const weekOffset= (dateMonday.getTime() - week1Monday.getTime()) / 1000 / 60 / 60 / 24;

        const result =  1 + Math.round(weekOffset / 7);
        if(result === 53 && !has53) {
            return 1;
        } else {
            return result;
        }
    }

</script>


<div class="container-fluid bg-dark text-white">
    <footer class="py-4 mt-4 text-center">

        Ein Hobbyprojekt von <a class="text-white" href="https://www.input23.de">Tom</a>
      <p class="text-center text-muted">
        Daten- und Bildquelle: Deutscher Wetterdienst (DWD)<br />
        Hintergrundbild: css-pattern.com <br />
        Template: Bootstrap
    </p>
    </footer>
  </div>

</body>
</html>